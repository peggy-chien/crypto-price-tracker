import{D as m,d as W,e as x,f as y,g as h,h as E,j as p,ka as B,n as T,s as v,u as _,w as d,x as j}from"./chunk-RMUOB2GJ.js";var M={url:"",deserializer:c=>JSON.parse(c.data),serializer:c=>JSON.stringify(c)},O="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",k=class c extends E{constructor(e,t){if(super(),this._socket=null,e instanceof y)this.destination=t,this.source=e;else{let i=this._config=Object.assign({},M);if(this._output=new h,typeof e=="string")i.url=e;else for(let r in e)e.hasOwnProperty(r)&&(i[r]=e[r]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new p}}lift(e){let t=new c(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new p),this._output=new h}multiplex(e,t,i){let r=this;return new y(o=>{try{r.next(e())}catch(n){o.error(n)}let s=r.subscribe({next:n=>{try{i(n)&&o.next(n)}catch(a){o.error(a)}},error:n=>o.error(n),complete:()=>o.complete()});return()=>{try{r.next(t())}catch(n){o.error(n)}s.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:t,url:i,binaryType:r}=this._config,o=this._output,s=null;try{s=t?new e(i,t):new e(i),this._socket=s,r&&(this._socket.binaryType=r)}catch(a){o.error(a);return}let n=new W(()=>{this._socket=null,s&&s.readyState===1&&s.close()});s.onopen=a=>{let{_socket:u}=this;if(!u){s.close(),this._resetState();return}let{openObserver:w}=this._config;w&&w.next(a);let g=this.destination;this.destination=x.create(l=>{if(s.readyState===1)try{let{serializer:b}=this._config;s.send(b(l))}catch(b){this.destination.error(b)}},l=>{let{closingObserver:b}=this._config;b&&b.next(void 0),l&&l.code?s.close(l.code,l.reason):o.error(new TypeError(O)),this._resetState()},()=>{let{closingObserver:l}=this._config;l&&l.next(void 0),s.close(),this._resetState()}),g&&g instanceof p&&n.add(g.subscribe(this.destination))},s.onerror=a=>{this._resetState(),o.error(a)},s.onclose=a=>{s===this._socket&&this._resetState();let{closeObserver:u}=this._config;u&&u.next(a),a.wasClean?o.complete():o.error(a)},s.onmessage=a=>{try{let{deserializer:u}=this._config;o.next(u(a))}catch(u){o.error(u)}}}_subscribe(e){let{source:t}=this;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:i}=this;this._output.observers.length===0&&(i&&(i.readyState===1||i.readyState===0)&&i.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};function S(c){return new k(c)}var f=class c{visibleSignal=m(!document.hidden);constructor(){document.addEventListener("visibilitychange",()=>{this.visibleSignal.set(!document.hidden)})}get isVisible(){return this.visibleSignal.asReadonly()}static \u0275fac=function(t){return new(t||c)};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};var P=class c{streams=new Map;multiWs=null;multiSignal=m([]);multiDestroy$=new h;multiPairs=[];RECONNECT_INTERVAL=5e3;activeSymbols=new Set;appVisibility=j(f);constructor(){B(()=>{if(!this.appVisibility.isVisible())this.closeAll();else{for(let e of this.activeSymbols)this.streams.has(e)||this.subscribeToTicker(e);this.multiPairs.length>0&&!this.multiWs&&this.subscribeToTickers(this.multiPairs)}})}subscribeToTicker(e){let t=e.toUpperCase();this.unsubscribeFromTicker(e),this.activeSymbols.add(t);let i=m(null),r=new h,o=S({url:`wss://stream.binance.com:9443/ws/${e.toLowerCase()}@ticker`,openObserver:{next:()=>console.log("[BinanceWebsocketService] WebSocket connected")}});return o.pipe(v({delay:()=>T(this.RECONNECT_INTERVAL),resetOnSuccess:!0}),_(r)).subscribe({next:s=>{try{let n={symbol:s.s,price:parseFloat(s.c),change:parseFloat(s.P)};i.set(n)}catch(n){console.error("[BinanceWebsocketService] Message processing error:",n)}},error:s=>{console.error("[BinanceWebsocketService] WebSocket error:",s)},complete:()=>{console.log("[BinanceWebsocketService] WebSocket connection closed")}}),this.streams.set(t,{ws:o,destroy$:r,signal:i}),i}subscribeToTickers(e){this.unsubscribeFromTickers(),this.multiPairs=e;let t=e.map(r=>`${r.toLowerCase()}@ticker`).join("/");this.multiWs=S({url:`wss://stream.binance.com:9443/stream?streams=${t}`,openObserver:{next:()=>console.log("[BinanceWebsocketService] Multi-ticker WebSocket connected")}});let i={};return this.multiWs.pipe(v({delay:()=>T(this.RECONNECT_INTERVAL),resetOnSuccess:!0}),_(this.multiDestroy$)).subscribe({next:r=>{try{if(r.data){let o={symbol:r.data.s,price:parseFloat(r.data.c),change:parseFloat(r.data.P)};i[o.symbol]=o,this.multiSignal.set(Object.values(i))}}catch(o){console.error("[BinanceWebsocketService] Multi-ticker message processing error:",o)}},error:r=>{console.error("[BinanceWebsocketService] Multi-ticker WebSocket error:",r)},complete:()=>{console.log("[BinanceWebsocketService] Multi-ticker WebSocket connection closed")}}),this.multiSignal}unsubscribeFromTicker(e){let t=e.toUpperCase(),i=this.streams.get(t);i&&(i.destroy$.next(),i.destroy$.complete(),i.ws.complete(),this.streams.delete(t)),this.activeSymbols.delete(t)}unsubscribeFromTickers(){this.multiWs&&(this.multiDestroy$.next(),this.multiDestroy$.complete(),this.multiWs.complete(),this.multiWs=null,this.multiSignal.set([]),this.multiPairs=[])}closeAll(){for(let[e,t]of this.streams.entries())t.destroy$.next(),t.destroy$.complete(),t.ws.complete(),this.streams.delete(e);this.unsubscribeFromTickers()}getMultiSignal(){return this.multiSignal}static \u0275fac=function(t){return new(t||c)};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};export{S as a,f as b,P as c};
